<%= form_with model: order, local: true, html: { multipart: true, class: "space-y-6", id: "order-form" } do |form| %>
  <% if order.errors.any? %>
    <div class="alert alert-error">
      <div>
        <strong><%= pluralize(order.errors.count, "error") %> prohibited this order from being saved:</strong>
        <ul>
          <% order.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 左側のコラム -->
    <div class="space-y-6">
      <!-- 基本情報 -->
      <div class="card bg-white shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">基本情報</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <%= form.label :client_id, "クライアント", class: "label label-text-alt" %>
              <%= form.collection_select :client_id, Client.all, :id, :name, 
                  { prompt: "クライアントを選択してください" }, 
                  { class: "select select-bordered w-full" } %>
            </div>
            
            <div class="form-control">
              <%= form.label :factory_name, "サプライヤー", class: "label label-text-alt" %>
              <%= form.text_field :factory_name, class: "input input-bordered" %>
            </div>
            
            <div class="form-control">
              <%= form.label :order_date, "注文日", class: "label label-text-alt" %>
              <%= form.date_field :order_date, class: "input input-bordered", value: order.order_date || Date.current %>
            </div>
            
            <div class="form-control">
              <%= form.label :shipping_date, "ETD (出発予定日)", class: "label label-text-alt" %>
              <%= form.date_field :shipping_date, class: "input input-bordered" %>
            </div>
            
            <div class="form-control">
              <%= form.label :delivery_date, "納期", class: "label label-text-alt" %>
              <%= form.date_field :delivery_date, class: "input input-bordered" %>
            </div>

            <div class="form-control">
              <%= form.label :estimate_delivery_date, "推定納期", class: "label label-text-alt" %>
              <%= form.date_field :estimate_delivery_date, class: "input input-bordered" %>
            </div>
          </div>
        </div>
      </div>

      <!-- 製品情報 -->
      <div class="card bg-white shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">製品情報</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <%= form.label :item_number, "製品コード", class: "label label-text-alt" %>
              <%= form.text_field :item_number, class: "input input-bordered", placeholder: "例: O11591Xx" %>
            </div>
            
            <div class="form-control">
              <%= form.label :item_name, "製品名", class: "label label-text-alt" %>
              <%= form.text_field :item_name, class: "input input-bordered", placeholder: "例: PO, BLOUSON" %>
            </div>
            
            <div class="form-control">
              <%= form.label :quantity, "数量", class: "label label-text-alt" %>
              <%= form.number_field :quantity, class: "input input-bordered", min: 1, step: 1, id: "quantity" %>
            </div>
            
            <div class="form-control">
              <%= form.label :trade_term, "貿易条件", class: "label label-text-alt" %>
              <%= form.select :trade_term, 
                  options_for_select([
                    ['FOB', 'FOB'],
                    ['CIF', 'CIF'],
                    ['EXW', 'EXW'],
                    ['DDP', 'DDP']
                  ], order.trade_term), 
                  { prompt: '選択してください' }, 
                  { class: "select select-bordered" } %>
            </div>

            <div class="form-control">
              <%= form.label :export_port, "輸出港", class: "label label-text-alt" %>
              <%= form.text_field :export_port, class: "input input-bordered", placeholder: "例: 上海, 青島" %>
            </div>

            <div class="form-control">
              <%= form.label :license, "ライセンス", class: "label label-text-alt" %>
              <%= form.text_field :license, class: "input input-bordered" %>
            </div>
          </div>
        </div>
      </div>

      <!-- 担当者 -->
      <div class="card bg-white shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">担当者</h2>
          <div class="form-control">
            <label class="label label-text-alt">担当者を選択</label>
            <div class="space-y-2">
              <% @users.each do |user| %>
                <label class="label cursor-pointer">
                  <%= check_box_tag "order[user_ids][]", user.id, 
                                    order.users.include?(user), 
                                    class: "checkbox checkbox-primary" %>
                  <span class="label-text"><%= user.family_name_kanji %> <%= user.given_name_kanji %> (<%= user.family_name_eng %> <%= user.given_name_eng %>)</span>
                </label>
              <% end %>
            </div>
            <p class="text-sm text-gray-500 mt-2">複数の担当者を選択できます</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 右側のコラム -->
    <div class="space-y-6">
      <!-- 価格・財務情報 -->
      <div class="card bg-white shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">価格・財務情報</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <%= form.label :purchase_price, "仕入単価", class: "label label-text-alt" %>
              <%= form.number_field :purchase_price, class: "input input-bordered", min: 0, step: 0.01, id: "purchase_price" %>
            </div>
            
            <div class="form-control">
              <%= form.label :sell_price, "販売単価", class: "label label-text-alt" %>
              <%= form.number_field :sell_price, class: "input input-bordered", min: 0, step: 1, id: "sell_price" %>
            </div>

            <div class="form-control">
              <%= form.label :exchange_rate, "為替レート", class: "label label-text-alt" %>
              <%= form.number_field :exchange_rate, class: "input input-bordered", min: 0, step: 0.01, id: "exchange_rate" %>
            </div>

            <div class="form-control">
              <%= form.label :sales_multiple, "掛率", class: "label label-text-alt" %>
              <%= form.number_field :sales_multiple, class: "input input-bordered", min: 0, step: 0.01, id: "sales_multiple" %>
            </div>
          </div>

          <!-- 計算結果表示 -->
          <div class="divider"></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label label-text-alt">仕入総額</label>
              <div class="input input-bordered bg-gray-50" id="total_purchase_amount">¥0</div>
            </div>
            
            <div class="form-control">
              <label class="label label-text-alt">売上総額</label>
              <div class="input input-bordered bg-gray-50" id="total_sales_amount">¥0</div>
            </div>
            
            <div class="form-control">
              <label class="label label-text-alt">粗利益額</label>
              <div class="input input-bordered bg-gray-50" id="gross_profit_amount">¥0</div>
            </div>
            
            <div class="form-control">
              <label class="label label-text-alt">粗利率</label>
              <div class="input input-bordered bg-gray-50" id="gross_profit_percentage">0%</div>
            </div>
            
            <div class="form-control">
              <label class="label label-text-alt">マークアップ率 (%)</label>
              <div class="input input-bordered bg-gray-50" id="markup_rate">0%</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 添付ファイル -->
      <div class="card bg-white shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">添付ファイル</h2>
          <div class="space-y-4">
            <!-- ファイル添付 -->
            <div class="form-control">
              <label class="label label-text-alt">ファイル</label>
              <div id="file-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-gray-400 transition-colors">
                <%= form.file_field :files, multiple: true, class: "hidden", id: "file-input" %>
                <div class="space-y-2">
                  <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <p class="text-gray-600">
                    <span class="font-medium text-blue-600 hover:text-blue-500">クリックしてファイルを選択</span>
                    <span class="text-gray-500">またはここにファイルをドラッグ＆ドロップ</span>
                  </p>
                  <p class="text-sm text-gray-500">複数ファイルを選択できます（形式は問いません）</p>
                </div>
              </div>
            </div>

            <!-- URL管理 -->
            <div class="form-control">
              <label class="label label-text-alt">関連URL</label>
              <div id="url-fields" class="space-y-2">
                <% if order.attachment_urls.present? %>
                  <% order.attachment_urls.each do |url| %>
                    <div class="url-field flex gap-2">
                      <input type="text" name="order[attachment_urls][]" value="<%= url %>" class="input input-bordered flex-1" placeholder="https://example.com/document">
                      <button type="button" class="btn btn-warning btn-sm remove-url">削除</button>
                    </div>
                  <% end %>
                <% else %>
                  <div class="url-field flex gap-2">
                    <input type="text" name="order[attachment_urls][]" class="input input-bordered flex-1" placeholder="https://example.com/document">
                    <button type="button" class="btn btn-warning btn-sm remove-url">削除</button>
                  </div>
                <% end %>
              </div>
              <button type="button" id="add-url" class="btn btn-sm btn-outline mt-2">URLを追加</button>
              <p class="text-sm text-gray-500 mt-2">関連ドキュメントやリソースへのリンクを入力してください</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 送信ボタン -->
  <div class="flex justify-end space-x-4">
    <%= link_to "キャンセル", orders_path, class: "btn btn-outline" %>
    <%= form.submit button_text, class: "btn btn-neutral" %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 計算機能
  function updateCalculations() {
    const quantity = parseFloat(document.getElementById('quantity').value) || 0;
    const purchasePrice = parseFloat(document.getElementById('purchase_price').value) || 0;
    const sellPrice = parseFloat(document.getElementById('sell_price').value) || 0;
    
    // 総仕入額
    const totalPurchaseAmount = quantity * purchasePrice;
    document.getElementById('total_purchase_amount').textContent = 
      '¥' + new Intl.NumberFormat('ja-JP').format(totalPurchaseAmount);
    
    // 総売上額
    const totalSalesAmount = quantity * sellPrice;
    document.getElementById('total_sales_amount').textContent = 
      '¥' + new Intl.NumberFormat('ja-JP').format(totalSalesAmount);
    
    // 粗利益額
    const grossProfitAmount = totalSalesAmount - totalPurchaseAmount;
    document.getElementById('gross_profit_amount').textContent = 
      '¥' + new Intl.NumberFormat('ja-JP').format(grossProfitAmount);
    
    // 粗利率
    const grossProfitPercentage = totalPurchaseAmount !== 0 
      ? ((grossProfitAmount / totalPurchaseAmount) * 100)
      : 0;
    document.getElementById('gross_profit_percentage').textContent = 
      grossProfitPercentage.toFixed(2) + '%';
    
    // マークアップ率
    const markupRate = purchasePrice !== 0 
      ? (((sellPrice - purchasePrice) / purchasePrice) * 100)
      : 0;
    document.getElementById('markup_rate').textContent = 
      markupRate.toFixed(2) + '%';
  }

  // イベントリスナーを追加
  ['quantity', 'purchase_price', 'sell_price'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('input', updateCalculations);
      element.addEventListener('change', updateCalculations);
    }
  });

  // 初期計算
  updateCalculations();

  // URL管理
  const addUrlButton = document.getElementById('add-url');
  const urlFieldsContainer = document.getElementById('url-fields');

  if (addUrlButton) {
    addUrlButton.addEventListener('click', function() {
      const newUrlField = `
        <div class="url-field flex gap-2 mb-2">
          <input type="text" name="order[attachment_urls][]" class="input input-bordered flex-1" placeholder="https://example.com/document">
          <button type="button" class="btn btn-warning btn-sm remove-url">削除</button>
        </div>
      `;
      urlFieldsContainer.insertAdjacentHTML('beforeend', newUrlField);
    });
  }

  if (urlFieldsContainer) {
    urlFieldsContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-url')) {
        const urlField = e.target.closest('.url-field');
        if (urlFieldsContainer.children.length > 1) {
          urlField.remove();
        } else {
          urlField.querySelector('input').value = '';
        }
      }
    });
  }

  // ファイルドロップゾーン
  const dropZone = document.getElementById('file-drop-zone');
  const fileInput = document.getElementById('file-input');

  if (!dropZone || !fileInput) {
    return;
  }

  // Prevent default drag behaviors on the entire document
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    document.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // Drag and drop event listeners
  dropZone.addEventListener('dragenter', handleDragEnter);
  dropZone.addEventListener('dragover', handleDragOver);
  dropZone.addEventListener('dragleave', handleDragLeave);
  dropZone.addEventListener('drop', handleDrop);
  dropZone.addEventListener('click', handleClick);

  function handleDragEnter(e) {
    dropZone.classList.add('border-blue-400', 'bg-blue-50');
  }

  function handleDragOver(e) {
    dropZone.classList.add('border-blue-400', 'bg-blue-50');
  }

  function handleDragLeave(e) {
    if (!dropZone.contains(e.relatedTarget)) {
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    }
  }

  function handleDrop(e) {
    dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      displaySelectedFiles(files);
    }
  }

  function handleClick(e) {
    if (e.target === dropZone || dropZone.contains(e.target)) {
      fileInput.click();
    }
  }

  fileInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      displaySelectedFiles(e.target.files);
    }
  });

  function displaySelectedFiles(files) {
    const fileList = Array.from(files).map(file => file.name).join(', ');
    const fileCountText = `${files.length}個のファイルが選択されました: ${fileList}`;
    
    // Find or create a display element for selected files
    let fileDisplay = dropZone.querySelector('.selected-files-display');
    if (!fileDisplay) {
      fileDisplay = document.createElement('div');
      fileDisplay.className = 'selected-files-display mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm text-green-800';
      dropZone.appendChild(fileDisplay);
    }
    
    fileDisplay.textContent = fileCountText;
  }
});
</script>
