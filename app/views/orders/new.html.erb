<div class="p-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900">新規オーダー作成</h1>
    <%= link_to "戻る", orders_path, class: "btn btn-outline" %>
  </div>

  <%= form_with model: @order, local: true, class: "space-y-6" do |form| %>
    <% if @order.errors.any? %>
      <div class="alert alert-error">
        <h4><%= pluralize(@order.errors.count, "error") %> prohibited this order from being saved:</h4>
        <ul>
          <% @order.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- 基本情報 -->
      <div class="card bg-white shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">基本情報</h2>
          
          <div class="form-control">
            <%= form.label :client, "クライアント", class: "label" %>
            <%= form.text_field :client, class: "input input-bordered w-full", required: true %>
          </div>

          <div class="form-control">
            <%= form.label :factory_name, "工場名", class: "label" %>
            <%= form.text_field :factory_name, class: "input input-bordered w-full", required: true %>
          </div>

          <div class="form-control">
            <%= form.label :order_date, "注文日", class: "label" %>
            <%= form.date_field :order_date, class: "input input-bordered w-full", required: true, value: Date.current %>
          </div>

          <div class="form-control">
            <%= form.label :shipping_date, "出荷予定日", class: "label" %>
            <%= form.date_field :shipping_date, class: "input input-bordered w-full" %>
          </div>

          <div class="form-control">
            <%= form.label :delivery_date, "納期", class: "label" %>
            <%= form.date_field :delivery_date, class: "input input-bordered w-full" %>
          </div>
        </div>
      </div>

      <!-- 担当者選択 -->
      <div class="card bg-white shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">担当者</h2>
          
          <div class="form-control">
            <%= form.label :user_ids, "担当者を選択", class: "label" %>
            <div class="space-y-2 max-h-48 overflow-y-auto">
              <% @users.each do |user| %>
                <label class="label cursor-pointer justify-start gap-3">
                  <%= check_box_tag "order[user_ids][]", user.id, false, 
                                    class: "checkbox checkbox-primary", 
                                    id: "order_user_ids_#{user.id}" %>
                  <span class="label-text">
                    <%= user.full_name_kanji %> (<%= user.full_name_eng %>)
                  </span>
                </label>
              <% end %>
            </div>
            <p class="text-sm text-gray-500 mt-2">複数の担当者を選択できます</p>
          </div>
        </div>
      </div>
    </div>

    <!-- オーダーアイテム -->
    <div class="card bg-white shadow">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title text-lg">オーダーアイテム</h2>
          <button type="button" id="add-item" class="btn btn-sm btn-primary">アイテム追加</button>
        </div>
        
        <div id="order-items">
          <%= form.fields_for :order_items do |item_form| %>
            <div class="order-item border rounded-lg p-4 mb-4">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="form-control">
                  <%= item_form.label :name, "アイテム名", class: "label label-text-alt" %>
                  <%= item_form.text_field :name, class: "input input-bordered input-sm", required: true %>
                </div>
                
                <div class="form-control">
                  <%= item_form.label :quantity, "数量", class: "label label-text-alt" %>
                  <%= item_form.number_field :quantity, class: "input input-bordered input-sm", min: 1, required: true %>
                </div>
                
                <div class="form-control">
                  <%= item_form.label :unit_price, "単価 (¥)", class: "label label-text-alt" %>
                  <%= item_form.number_field :unit_price, class: "input input-bordered input-sm", min: 0, step: 0.01, required: true %>
                </div>
                
                <div class="form-control">
                  <label class="label label-text-alt">アクション</label>
                  <button type="button" class="btn btn-sm btn-error remove-item">削除</button>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- 送信ボタン -->
    <div class="flex justify-end space-x-4">
      <%= link_to "キャンセル", orders_path, class: "btn btn-outline" %>
      <%= form.submit "オーダーを作成", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const addItemButton = document.getElementById('add-item');
  const orderItemsContainer = document.getElementById('order-items');
  let itemIndex = <%= @order.order_items.length %>;

  addItemButton.addEventListener('click', function() {
    const newItem = `
      <div class="order-item border rounded-lg p-4 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="form-control">
            <label class="label label-text-alt">アイテム名</label>
            <input type="text" name="order[order_items_attributes][${itemIndex}][name]" class="input input-bordered input-sm" required>
          </div>
          
          <div class="form-control">
            <label class="label label-text-alt">数量</label>
            <input type="number" name="order[order_items_attributes][${itemIndex}][quantity]" class="input input-bordered input-sm" min="1" required>
          </div>
          
          <div class="form-control">
            <label class="label label-text-alt">単価 (¥)</label>
            <input type="number" name="order[order_items_attributes][${itemIndex}][unit_price]" class="input input-bordered input-sm" min="0" step="0.01" required>
          </div>
          
          <div class="form-control">
            <label class="label label-text-alt">アクション</label>
            <button type="button" class="btn btn-sm btn-error remove-item">削除</button>
          </div>
        </div>
      </div>
    `;
    orderItemsContainer.insertAdjacentHTML('beforeend', newItem);
    itemIndex++;
  });

  orderItemsContainer.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-item')) {
      e.target.closest('.order-item').remove();
    }
  });
});
</script>