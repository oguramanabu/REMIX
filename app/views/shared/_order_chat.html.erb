<% if order.persisted? %>
  <div class="card bg-white shadow mt-6" 
       data-controller="order-chat"
       data-order-chat-order-id-value="<%= order.id %>"
       data-order-chat-current-user-id-value="<%= Current.user.id %>"
       data-order-chat-current-user-name-value="<%= Current.user.family_name_kanji %>">
    <div class="card-body">
      <h2 class="card-title text-lg mb-4">
        💬 チャット
      </h2>
      <!-- Chat Messages Container -->
      <div class="relative">
        <!-- Messages Display -->
        <div class="border rounded-lg mb-4 h-80 overflow-y-auto p-4 bg-gray-50" 
             data-order-chat-target="messages">
          <!-- Messages will be loaded here -->
        </div>
        <!-- Mention Suggestions -->
        <div class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden whitespace-nowrap"
             data-order-chat-target="mentionList">
          <!-- Mention suggestions will appear here -->
        </div>
        <!-- Message Input Form -->
        <form data-order-chat-target="form" 
              data-action="submit->order-chat#sendMessage"
          class="flex gap-2">
          <div class="flex-1 relative">
            <textarea class="textarea textarea-bordered w-full resize-none" 
                     data-order-chat-target="input"
                     placeholder="メッセージを入力... (@ユーザー名 でメンション可能)"
                     rows="2"></textarea>
          </div>
          <button type="submit" class="btn btn-primary self-end">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            送信
          </button>
        </form>
        <!-- Chat Instructions -->
        <div class="text-xs text-gray-500 mt-2">
          <p>💡 ヒント: @ユーザー名 でメンションすると相手に通知されます</p>
        </div>
      </div>
    </div>
  </div>
<% end %>
<style>
  .mention {
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .chat-bubble {
    word-wrap: break-word;
    max-width: 300px;
  }
  
  .mention-item.selected {
    background-color: #e3f2fd !important;
  }
</style>
